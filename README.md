# Heater Service Bot

Telegram-бот для сервисной компании, специализирующейся на монтаже и
ремонте систем отопления и водоснабжения. Бот выполняет функции воронки
продаж, обеспечивает взаимодействие с клиентами и администрирование
заявок.

## Основные возможности

### Для пользователей

-   Получение информации об услугах компании (монтаж, ремонт, стоимость)
-   Просмотр реализованных проектов с фотографиями
-   Заказ обратного звонка 
-   Отправка заявки на расчет стоимости через WebApp-форму с прикреплением фото/видео
-   Консультация по выбору оборудования и услуг

### Для администраторов

-   Получение уведомлений о новых заявках в групповом чате
-   Система отложенных напоминаний для обработки заявок (5, 10, 20, 30
    минут)
-   Выгрузка базы пользователей в Excel:
    -   Все пользователи (`/all_users`)
    -   Пользователи со статусом “Гость” (`/guests`)
    -   Пользователи со статусом “Клиент” (`/clients`)
    -   Неактивные клиенты (более 7 дней) (`/inactive`)

### Технические особенности

-   Асинхронная архитектура на aiogram 3.x
-   Двухканальная работа: личные сообщения + групповой чат админов
-   Система отложенных напоминаний для обработки заявок
-   WebApp-интеграция для сбора данных от клиентов
-   Автоматическая классификация пользователей (Гость/Клиент)
-   Выгрузка отчетов в Excel по различным критериям
-   Полноценная документация кода с pdoc

## Технологии

### Бэкенд

-   Python 3.12+
-   Aiogram 3.22.0 (асинхронный фреймворк для Telegram)
-   SQLAlchemy 2.0 (асинхронный ORM)
-   PostgreSQL 16 (основная база данных)
-   Pydantic 2.11.7 (валидация настроек)
-   Alembic 1.16.5 (миграции базы данных)

### Фронтенд

-   WebApp Telegram (HTML/JS формы для сбора данных)
-   Инлайн-кнопки и Reply-клавиатуры
-   Bootstrap 5 (для WebApp интерфейсов)

### Инфраструктура

-   Docker + Docker Compose
-   PostgreSQL
-   Poetry (управление зависимостями)
-   Makefile (автоматизация задач)
-   Pdoc (генерация документации)

## Установка и запуск

### Локальная разработка

1.  Клонировать репозиторий:

``` bash
git clone https://github.com/NEONAVT/heater_service_bot
cd heater_service_bot
```

2.  Установить Poetry (если не установлен):

``` bash
pip install poetry
```

3.  Установить зависимости:

``` bash
poetry install
```

4.  Настроить окружение — создать в корневой директории `.env` и
    заполнить переменные [**(см. раздел “Переменные окружения” ниже)**](#для-локального-запуска).

5.  Создать базу данных и пользователя PostgreSQL в соответствии с
    `.env`:

``` bash
psql -U postgres -h localhost -p 5432 -c "CREATE DATABASE heater_service_db;"
psql -U postgres -h localhost -p 5432 -c "CREATE USER heater_service_user WITH PASSWORD 'secure_password_here';"
psql -U postgres -h localhost -p 5432 -c "GRANT ALL PRIVILEGES ON DATABASE heater_service_db TO heater_service_user;"
```

6.  Применить миграции базы данных:

``` bash
make migrate-apply
```

7.  Запустить бота:

``` bash
make run
```

### Запуск через Docker

1.  Создать файл `.env` и заполнить настройки [**(см. раздел “Переменные окружения” ниже)**](#для-запуска-через-docker)

2.  Запустить контейнеры:

``` bash
docker-compose up -d
```

3.  Просмотр логов:

``` bash
docker-compose logs -f app
```

4.  Остановка контейнеров:

``` bash
docker-compose down
```

Приложение будет запущено и готово к работе. Бот начнет отвечать на
сообщения.

## Структура проекта

    heater_service_bot/
    ├── bot_config/           # Конфигурация бота и Telegram клиент
    ├── database/             # Подключение к БД (асинхронное + синхронное)
    ├── handlers/             # Обработчики сообщений
    │   ├── group_handlers/   # Команды для группового чата админов
    │   └── private_handlers/ # Обработчики личных сообщений
    ├── keyboards/            # Клавиатуры (Reply + Inline)
    ├── models/               # Модели SQLAlchemy (Users, Reminders)
    ├── repository/           # Слой работы с БД (репозитории)
    ├── services/             # Бизнес-логика и сервисы
    ├── filters/              # Кастомные фильтры для хендлеров
    ├── setup/                # Настройка роутеров и команд
    ├── projects_images/      # Изображения проектов для демонстрации
    ├── alembic/              # Миграции базы данных
    └── docs_html/            # Автогенерируемая документация

### Взаимодействие слоев:
Запрос → Handlers → Services → Repository → Database  
Ответ ← Handlers ← Services ← Repository ← Database

### Основные файлы: 
- `main.py`- точка входа приложения 
- `settings.py` - настройки приложения (Pydantic) 
- `docker-compose.yml` - конфигурация Docker 
- `Makefile` - автоматизация задач и команд
- `pyproject.toml` - зависимости Poetry

## Переменные окружения:

Для запуска бота необходимо создать в корневой директории проекта файл
`.env` со следующими переменными:

### Обязательные переменные:

``` env
BOT_TOKEN=your_telegram_bot_token_here
ADMIN_CHAT_ID=-your_group_chat_id_here
```

### Настройки базы данных:
#### Для локального запуска:
``` env
DB_HOST=localhost
DB_PORT=5432
DB_USER=heater_service_user
DB_PASS=secure_password_here
DB_NAME=heater_service_db
DB_DRIVER=postgresql+asyncpg
DB_SYNC_DRIVER=postgresql+psycopg2
```

#### Для запуска через Docker:
``` env
DB_HOST=db
DB_PORT=5432
DB_USER=heater_service_user
DB_PASS=secure_password_here
DB_NAME=heater_service_db
DB_DRIVER=postgresql+asyncpg
DB_SYNC_DRIVER=postgresql+psycopg2
```

### Получение необходимых значений:

1.  **BOT_TOKEN** — токен вашего Telegram бота:
    -   Создайте бота через [@BotFather](https://t.me/BotFather).
    -   Скопируйте выданный токен.
2.  **ADMIN_CHAT_ID** — идентификатор группового чата:
    -   Создайте групповой чат в Telegram.
    -   Добавьте в чат [@SimpleID_Bot](https://t.me/SimpleID_Bot).
    -   Выполните команду `/start` в группе.
    -   Бот пришлёт ID чата (начинается с `-`).
    -   Скопируйте полученный ID.
3.  **Настройки PostgreSQL** — измените под вашу конфигурацию при
    необходимости.

### Важные примечания:

-   ID группового чата должен начинаться с `-` (пример:
    `-1001234567890`).
-   Бот должен иметь права администратора в групповом чате.
-   После внесения изменений в `.env` перезапустите приложение.

## Документация

С документацией проекта можно ознакомиться по команде:

``` bash
make open-docs
```

Это сгенерирует и откроет полную документацию по всем модулям проекта,
созданную с помощью pdoc.

## Контакты

Разработчик: Клим Клушин  
Email: klim.klushin@gmail.com  
Телефон: +7 978 661 59 23  
Telegram: [@klim_klushin](http://t.me/klim_klushin)  

